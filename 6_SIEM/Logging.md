# GHI NHẬT KÝ (LOGGING) LÀ GÌ?

Nhật ký (Logs) là các danh sách chi tiết về thông tin ứng dụng, số liệu thống kê hiệu suất hệ thống hoặc các hoạt động của người dùng. Nhật ký rất hữu ích trong việc theo dõi tình trạng sử dụng máy tính, hoạt động mạng, các vấn đề bảo mật và báo cáo lỗi. 

Mọi hoạt động trên môi trường của bạn, từ việc gửi email, đăng nhập cho đến các bản cập nhật tường lửa, đều được coi là một sự kiện bảo mật. Các sự kiện này được (hoặc nên được) ghi lại để theo dõi sát sao mọi thứ đang diễn ra trong bối cảnh công nghệ của tổ chức.

### Cách sử dụng nhật ký cho mục đích bảo mật:

* **Trong môi trường Windows Active Directory:** Cho phép theo dõi khi nào các tài khoản đăng nhập, các nỗ lực nhập sai mật khẩu, việc sử dụng tài khoản quản trị, hoặc khi các tài khoản mới được tạo/xóa. Đây là cách hiệu quả để phát hiện các cuộc tấn công dò mật khẩu (brute-force) hoặc rải mật khẩu (password spraying).
* **Từ tường lửa (Firewall):** Giúp phát hiện hoạt động quét cổng (port scanning), quét lỗ hổng bảo mật, các cuộc tấn công từ chối dịch vụ (DoS) và các sự cố về mạng.

### Lưu ý quan trọng khi triển khai:

Việc xác định chính xác những nhật ký nào là cần thiết là vô cùng quan trọng. Trong các tổ chức lớn, khối lượng dữ liệu đẩy về SIEM có thể cực kỳ khổng lồ. Chúng ta cần lọc ra những nhật ký thực sự giá trị và thiết bị cần thiết để:
1. Giảm thiểu "độ nhiễu" (dữ liệu rác).
2. Tập trung phân tích các dữ liệu quan trọng thay vì bị ngợp trong kho dữ liệu khổng lồ.

**Quy tắc vàng:** SIEM không phải là kho lưu trữ nhật ký đơn thuần, chúng là các nền tảng phân tích!

### Các loại nhật ký quan trọng :
* **Syslog**
* **Windows Event Logs**
* **Các loại nhật ký khác (Other Logs)**

# Tổng quan về Syslog (System Logging Protocol)

Syslog là một giao thức tiêu chuẩn được sử dụng để truyền tải các thông báo sự kiện hoặc nhật ký hệ thống (log) đến một máy chủ chỉ định, được gọi là **Syslog server**.

## 1. Vai trò của Syslog
- **Tập trung hóa dữ liệu:** Khi có số lượng lớn thiết bị, việc kiểm tra log cục bộ trên từng máy là không khả thi. Syslog giúp tập trung log từ nhiều nguồn về một nơi để phân tích và xử lý.
- **Hỗ trợ thiết bị:** Có thể kích hoạt trên hầu hết các thiết bị mạng (Switch, Router, Firewall), các thiết bị đầu cuối, hệ thống Unix/Linux và nhiều máy chủ web.
- **Đối với Windows:** Mặc dù Windows sử dụng Windows Event Manager làm mặc định, nhưng vẫn có thể chuyển tiếp log đến Syslog server thông qua các tiện ích của bên thứ ba.

## 2. Cấu trúc của một thông điệp Syslog
Một thông điệp Syslog (theo tiêu chuẩn RFC 5424) bao gồm ba thành phần chính:

* **Priority Value (PRI):** Giá trị ưu tiên, dùng để phân loại loại thông báo và mức độ nghiêm trọng.
* **Header:** Chứa thông tin nhận dạng như: Dấu thời gian (Timestamp), Tên máy chủ (Hostname), Tên ứng dụng (Application name), ID thông điệp (Message ID).
* **Message:** Nội dung chi tiết của log. Phần này có thể ở dạng văn bản dễ đọc hoặc định dạng dành cho máy. Giao thức chỉ quy định định dạng, không quy định nội dung bên trong.

## 3. Giá trị ưu tiên (PRI)
Giá trị PRI được tính toán dựa trên mã cơ sở (Facility Code) và mức độ nghiêm trọng (Severity Level) theo công thức:

**PRI = (Facility Code * 8) + Severity Value**

### Bảng mã cơ sở (Facility Code)
Mô tả chức năng của ứng dụng/hệ thống tạo ra log:
| Mã | Mô tả |
| :--- | :--- |
| 0 | Kernel messages |
| 1 | User-level messages |
| 2 | Mail System |
| 3 | System Daemons |
| 4 | Security/Authorization Messages |
| 5 | Messages generated by syslog |
| ... | ... |
| 11 | FTP Daemon |
| 12 | NTP Subsystem |
| 13 | Log Audit |
| 14 | Log Alert |
| 16-23 | Local Use 0-7 |

### Bảng mức độ nghiêm trọng (Severity Levels)
| Giá trị | Mức độ | Từ khóa | Mô tả |
| :--- | :--- | :--- | :--- |
| 0 | Emergency | panic | Hệ thống không thể sử dụng. |
| 1 | Alert | alert | Cần hành động ngay lập tức (ví dụ: hỏng DB). |
| 2 | Critical | crit | Các điều kiện nguy kịch (lỗi thiết bị phần cứng). |
| 3 | Error | err | Các điều kiện lỗi. |
| 4 | Warning | warning | Các điều kiện cảnh báo. |
| 5 | Notice | notice | Bình thường nhưng quan trọng. |
| 6 | Informational | info | Các thông báo mang tính thông tin. |
| 7 | Debug | debug | Các thông báo dùng để gỡ lỗi. |

## 4. Các cổng và Giao thức kết nối
- **UDP 514 (Mặc định):** Được sử dụng phổ biến nhất nhưng không đảm bảo độ tin cậy.
- **TCP 514:** Được sử dụng khi cần sự tin cậy trong việc truyền tải dữ liệu.
- **TCP 6514:** Tiêu chuẩn thực tế (de facto) cho việc truyền tải log bảo mật (có mã hóa), dù không phải là tiêu chuẩn chính thức.

## 5. Lưu ý về Bảo mật
- **Thiếu bảo mật tích hợp:** Syslog mặc định không có tính năng xác thực hoặc mã hóa tích hợp, do đó dễ bị tấn công nếu không được cấu hình thêm các lớp bảo mật.
- **Lưu trữ:** Trên các hệ thống Unix, log thường được lưu trữ trong cây thư mục `/var/log`.

# Tổng quan về Windows Event Logs (Nhật ký sự kiện Windows)

## 1. Định nghĩa và Lưu trữ
* **Định nghĩa:** Là các tệp định dạng nhị phân (phần mở rộng `.evtx`) lưu trữ cục bộ các sự kiện xảy ra trên hệ thống.
* **Vị trí lưu trữ:**
    * **Windows 2000 đến WinXP/Server 2003:** `%Windir%\system32\Config.evt`
    * **Windows Vista đến Windows 10/Server 2008-2019:** `%Windir%\system32\WinEVT\Logs.evtx`
* **Vai trò:** Giúp quản trị viên theo dõi phần cứng, đăng nhập người dùng, thực thi chương trình, cài đặt... từ đó chẩn đoán lỗi và dự báo sự cố.

## 2. Các danh mục sự kiện chính
Hệ thống chia nhật ký thành nhiều loại để dễ quản lý:
* **Application (Ứng dụng):** Ghi lại sự kiện từ các phần mềm (lỗi thực thi, triển khai...).
* **System (Hệ thống):** Các sự kiện của hệ điều hành (lỗi khởi động, nạp driver...).
* **Security (Bảo mật):** Ghi lại đăng nhập/đăng xuất, xóa tệp, cấp quyền quản trị...
* **Directory Service:** Dành riêng cho Domain Controllers (lưu trữ sự kiện Active Directory).
* **DNS Server:** Lưu trữ nhật ký dịch vụ DNS.
* **File Replication Service:** Dành cho Domain Controllers, lưu sự kiện sao lưu (replication).

## 3. Nhật ký sự kiện bảo mật (Security Event Logs)
Đây là trọng tâm của việc giám sát hệ thống, liên quan đến các chính sách kiểm tra (audit policies):
* **Sự kiện đăng nhập:** Ghi lại cả lần đăng nhập thành công và thất bại.
* **Quản lý tài khoản:** Tạo, sửa, xóa hoặc tương tác với tài khoản người dùng.
* **Sử dụng đặc quyền:** Theo dõi việc dùng quyền quản trị.
* **Sử dụng tài nguyên:** Tạo, sửa, xóa các tệp tin và tài nguyên hệ thống.

## 4. Các mã định danh sự kiện (Event ID) quan trọng cần nhớ
Việc nắm vững các ID này giúp phản ứng nhanh với các sự cố:
* **4624:** Đăng nhập THÀNH CÔNG.
* **4625:** Đăng nhập THẤT BẠI.
* **4647:** Người dùng chủ động đăng xuất.
* **4648:** Đăng nhập bằng thông tin xác thực rõ ràng (explicit credentials).
* **4640:** Phát hiện tấn công phát lại (Replay attack).
* **4659:** Yêu cầu quyền truy cập đối tượng với ý định XÓA.
* **4706:** Một mối quan hệ tin cậy (trust) mới được tạo với domain.
* **4720:** Một tài khoản được TẠO.
* **4726:** Một tài khoản bị XÓA.
* **4732:** Thêm thành viên vào nhóm bảo mật cục bộ.
* **5379:** Đọc thông tin xác thực từ Credential Manager (thường xảy ra khi đăng nhập để kiểm tra tính hợp lệ).

## 5. Sử dụng công cụ Event Viewer
Đây là chương trình mặc định trên Windows để xem nhật ký:
* **Cách mở:** Tìm kiếm "Event Viewer" trong thanh Search và chạy với quyền Administrator.
* **Giao diện:**
    * **Cột giữa:** Hiển thị danh sách các sự kiện. Phần "Summary of Administrative Events" tóm tắt các lỗi (Error), cảnh báo (Warning) trong 7 ngày qua.
    * **Cột trái:** Cấu trúc cây thư mục (Windows Logs, Applications and Services Logs...).
    * **Chi tiết sự kiện:** Khi click vào một sự kiện, bạn sẽ thấy: Security ID, Account Name, Account Domain, Logon ID, thời gian và máy tính phát sinh sự kiện.

## 6. Chiến lược giám sát cho Security Team
* **Theo dõi thời gian bất thường:** Ví dụ, nhân viên văn phòng đăng nhập lúc 3 giờ sáng có thể là dấu hiệu tài khoản bị chiếm hữu hoặc mối đe dọa nội bộ.
* **Giám sát Special Logon (4672):** Đây là sự kiện khi tài khoản có quyền quản trị đăng nhập. Cần theo dõi chặt chẽ vì nếu kẻ tấn công chiếm được quyền này, chúng có thể gây hại nghiêm trọng.

## 7. Chế độ xem tùy chỉnh (Custom Views)
Giúp lọc bỏ "nhiễu" và chỉ tập trung vào những ID quan trọng:
* **Cách tạo:** Chuột phải vào "Custom Views" -> "Create Custom View".
* **Các tiêu chí lọc:**
    * **Logged:** Khoảng thời gian (1 giờ qua, 24 giờ qua, 7 ngày qua...).
    * **Event Level:** Mức độ (Critical, Error, Warning, Information).
    * **By Log:** Chọn nguồn nhật ký (ví dụ: Security, System).
    * **Event IDs:** Nhập các mã cần theo dõi, phân cách bằng dấu phẩy (Ví dụ: `4624, 4672, 4647, 4634`).
* **Lợi ích:** Giúp truy xuất nhanh các sự kiện liên quan đến một mã độc hoặc sự cố bảo mật cụ thể mà không cần SIEM.

# Tìm hiểu về Sysmon (System Monitor)

## 1. Định nghĩa và Cơ chế hoạt động
* **Định nghĩa**: Sysmon là một dịch vụ hệ thống và trình điều khiển thiết bị (device driver) của Windows.
* **Cơ chế**: Sau khi cài đặt, nó sẽ duy trì hoạt động ngay cả khi hệ thống khởi động lại để giám sát và ghi lại các hoạt động vào nhật ký sự kiện Windows (Windows Event Log).
* **Mục tiêu**: Cung cấp thông tin chi tiết để xác định các hoạt động độc hại hoặc bất thường, giúp hiểu cách thức kẻ tấn công và mã độc vận hành trong mạng.

## 2. Lợi ích và Khả năng giám sát
Sysmon cung cấp thông tin chuyên sâu hơn so với nhật ký Windows tiêu chuẩn:
* **Giám sát tiến trình**: Ghi lại việc tạo tiến trình với đầy đủ dòng lệnh (command line) của cả tiến trình hiện tại và tiến trình cha.
* **Tương quan sự kiện**: Bao gồm mã GUID của phiên (Session GUID) trong mỗi sự kiện để cho phép liên kết các sự kiện trong cùng một phiên đăng nhập.
* **Kiểm tra Driver/DLL**: Ghi lại việc nạp các trình điều khiển (drivers) hoặc thư viện DLL cùng với chữ ký và mã băm (hash) của chúng.
* **Kết nối mạng**: Tùy chọn ghi lại các kết nối mạng, bao gồm tiến trình nguồn, địa chỉ IP, số cổng, tên máy chủ và tên cổng.
* **Phát hiện thay đổi thời gian tệp**: Phát hiện các thay đổi về thời gian tạo tệp (Timestomping) - một kỹ thuật mã độc thường dùng để xóa dấu vết.
* **Lọc quy tắc**: Cho phép lọc để bao gồm hoặc loại trừ các sự kiện nhất định một cách linh hoạt.

## 3. Cài đặt Sysmon
* **Bước 1**: Tải xuống Sysmon từ trang web Sysinternals.
* **Bước 2**: Giải nén và mở Command Prompt (CMD) với quyền quản trị viên (Run as Administrator).
* **Bước 3**: Di chuyển đến thư mục chứa tệp thực thi và sử dụng lệnh `sysmon -i` để bắt đầu cài đặt.
* **Bước 4**: Chấp nhận các điều khoản trong bảng hiện ra (EULA).

## 4. Xem nhật ký Sysmon trong Event Viewer
Để xem nhật ký Sysmon một cách hiệu quả, bạn nên tạo một Chế độ xem tùy chỉnh (Custom View):
* **Tạo Custom View**: Trong Event Viewer, chọn "Create Custom View" ở bảng bên phải.
* **Thiết lập mức độ**: Đánh dấu vào tất cả các tùy chọn mức độ sự kiện (Critical, Warning, Error, Information, Verbose) để đảm bảo thấy được toàn bộ nhật ký.
* **Nguồn sự kiện**: Chọn nguồn là Sysmon trong danh sách "Event sources".

## 5. Quản lý cấu hình và Giảm nhiễu
* **Vấn đề**: Sysmon rất rộng và có thể tạo ra một lượng lớn dữ liệu "nhiễu" làm đầy hệ thống SIEM.
* **Giải pháp**: Sử dụng các tệp cấu hình (configuration files) để giảm bớt các nhật ký không cần thiết và tập trung vào các sự kiện quan trọng.
* **Tham khảo**: Một cấu hình mẫu phổ biến là `sysmon-config` của SwiftOnSecurity trên GitHub. Các tệp này thường có chú thích chi tiết, đóng vai trò như một tài liệu hướng dẫn về các nhật ký quan trọng cần giám sát.

# Chi tiết về các loại Log khác (Other Logs) - SIEM Domain

Tài liệu này cung cấp thông tin về các nguồn log không thuộc dạng truyền thống như Syslog, Sysmon hay Windows Event Logs. Đây là các hệ thống sử dụng phương pháp riêng để tạo và vận chuyển log, đặc biệt là trong môi trường đám mây và giám sát mạng chuyên sâu.

---

## 1. Giới thiệu chung
Ngoài các nguồn log phổ biến trên máy tính để bàn, máy chủ và thiết bị mạng, một số hệ thống hiện đại sử dụng các phương thức khác:
* **Cloud Providers (Azure, AWS):** Sử dụng Application Programming Interface (API) để ghi nhật ký và giám sát.
* **OSQuery:** Dành cho các điểm cuối (endpoints).
* **Moloch:** Dành cho việc chụp và lập chỉ mục lưu lượng mạng.

---

## 2. Microsoft Azure
Azure là một trong những dịch vụ đám mây phổ biến nhất, do đó việc hiểu cách điều hướng và giám sát log trong môi trường này là rất quan trọng.

### Công cụ giám sát chính:
* **Azure Monitor:** Thu thập log từ nhiều dịch vụ như Máy ảo (VM), mạng ảo, Azure Active Directory, Azure Security Center và cả các dịch vụ on-premises.
* **Log Analytics Workspaces:** Nơi tập trung để truy vấn và phân tích dữ liệu log.

### Các loại log chính trong Azure:
1. **Control/Management logs:** Log quản lý/điều khiển.
2. **Data Plane logs:** Log mặt phẳng dữ liệu.
3. **Processed Events:** Các sự kiện đã qua xử lý.

### Phương thức vận chuyển và tích hợp:
* Log được nạp qua Azure REST API, Microsoft Graph API, định dạng JSON và các nguồn khác.
* Có khả năng kết nối với các SIEM bên thứ ba như **Splunk** hoặc SIEM của riêng Microsoft là **Azure Sentinel**.
* **Kusto Query Language (KQL):** Ngôn ngữ truy vấn chính được sử dụng để khám phá log trong Azure.

---

## 3. Amazon Web Services (AWS)
AWS có quy mô cực kỳ lớn và sử dụng hệ thống API riêng biệt, sâu rộng để quản lý tài nguyên.

* **AWS API:** Có cấu trúc tương tự như REST API đơn giản.
* **Ví dụ về lời gọi API:** Một lệnh gọi có thể bao gồm các tham số như `Action=RunInstances`, `ImageId`, và thiết lập `Monitoring.Enabled=true`.
* **Bảo mật:** Sử dụng thành phần `AUTHPARAMS` để thực thi các cơ chế bảo mật khi gọi API, đảm bảo chỉ những thực thể được cấp quyền mới có thể thực hiện lệnh.

---

## 4. OSQuery
Được Facebook phát triển vào năm 2014, đây là một dự án mã nguồn mở mạnh mẽ dành cho các điểm cuối.

* **Khái niệm:** OSQuery coi hệ điều hành như một cơ sở dữ liệu quan hệ (relational database).
* **Ngôn ngữ:** Sử dụng **SQL** để truy vấn dữ liệu từ hệ điều hành (bất kể đó là Windows, Linux hay macOS).
* **Ưu điểm:** Tạo ra một tác nhân (agent) duy nhất cho nhiều hệ điều hành, sử dụng ngôn ngữ truy vấn tiêu chuẩn thay vì ngôn ngữ độc quyền.

### Các yếu tố cần xem xét khi triển khai OSQuery:
1. Cách cấu hình, triển khai và quản lý agent.
2. Quản lý các gói truy vấn (query packs) và lịch trình.
3. Nơi lưu trữ dữ liệu và chi phí lưu trữ.
4. Phương pháp phân tích dữ liệu để giải quyết các vấn đề bảo mật.
5. Quy trình xử lý các hoạt động khả nghi.
6. Khả năng tích hợp với các công cụ hiện có.
7. Cách khắc phục sự cố và phát triển chức năng tùy chỉnh.

---

## 5. Moloch
Moloch là công cụ bổ trợ cho hạ tầng bảo mật hiện tại bằng cách lưu trữ và lập chỉ mục lưu lượng mạng.

* **Định dạng dữ liệu:** Lưu trữ ở định dạng **PCAP** tiêu chuẩn, cho phép sử dụng các công cụ như Wireshark để phân tích.
* **Giao diện:** Cung cấp giao diện web trực quan để duyệt, tìm kiếm và xuất dữ liệu PCAP.
* **API:** Cung cấp các API để tải và tiêu thụ dữ liệu PCAP hoặc dữ liệu phiên (session) định dạng JSON trực tiếp.
* **Khả năng mở rộng:** Có thể xử lý lưu lượng lên đến hàng chục gigabits/giây.
* **Lưu trữ:** * Dữ liệu PCAP được lưu trữ dựa trên dung lượng đĩa của cảm biến (sensor).
    * Siêu dữ liệu (Metadata) được lưu trữ và lập chỉ mục dựa trên quy mô của cụm **Elasticsearch**.